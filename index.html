<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>È£õÈè¢Ë®àÂàÜ (v18.0 TLCÂ§ßÂ∏•Âì•)</title>
    <style>
        /* --- ÂÖ®ÂüüË®≠ÂÆö --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ecf0f1;
            margin: 0;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- È†ÇÈÉ®Ë≥áË®äÂàó --- */
        .top-bar {
            flex: 0 0 50px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 10;
        }
        .btn-ctrl {
            background: #505050; border: none; color: #fff;
            padding: 8px 16px; border-radius: 6px; font-size: 0.9rem;
            cursor: pointer;
        }
        .round-txt { color: #f1c40f; font-weight: bold; font-size: 1.1rem; }

        /* Èü≥ÊïàÊåâÈàï */
        #btn-sound {
            font-size: 1.2rem;
            background: transparent;
            border: 1px solid #555;
            width: 42px; height: 34px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            margin-right: 8px;
            color: #fff;
            transition: all 0.2s;
        }
        #btn-sound.off { opacity: 0.5; color: #888; text-decoration: line-through; }

        /* --- ÂàÜÊï∏Êùø --- */
        .scoreboard {
            flex: 0 0 auto;
            background: #1a1a1a;
            padding: 10px;
            display: flex;
            gap: 5px;
            overflow-x: auto;
        }
        .p-card {
            flex: 1;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 5px;
            text-align: center;
            opacity: 0.5;
            min-width: 60px;
            transition: 0.2s;
        }
        .p-card.active {
            opacity: 1;
            background: #3e3e3e;
            border-color: #f1c40f;
            transform: scale(1.02);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .p-score { font-size: 1.8rem; font-weight: bold; margin: 2px 0; }
        .p-darts { color: #f1c40f; font-size: 0.7rem; height: 1em; margin-top:2px; }

        /* --- È£õÈè¢Áõ§ÂçÄÂüü --- */
        #board-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(#222, #111);
            overflow: hidden;
            touch-action: none; 
        }

        #board-container {
            position: relative;
            width: 340px; height: 340px;
            max-width: 90vmin; max-height: 90vmin;
        }

        /* Ë¶ñÈáéÁØÑÂúçÁ∂≠ÊåÅ 450 (MissÂ•ΩÊåâ) */
        svg {
            width: 100%; height: 100%;
            pointer-events: none;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.6));
        }

        #touch-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 50; cursor: crosshair;
        }

        .btn-out-wrap { margin-top: 15px; z-index: 60; }
        #btn-out {
            background: #34495e; color: #ccc;
            border: 2px solid #555;
            padding: 15px 60px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }
        #btn-out:active { background: #c0392b; color: #fff; border-color: #e74c3c; }

        /* --- Á¥ÄÈåÑ --- */
        .log-panel {
            flex: none;
            height: 25vh;
            min-height: 150px;
            background: #1e1e1e;
            border-top: 2px solid #f1c40f;
            display: flex; flex-direction: column;
            z-index: 20;
        }
        .log-list {
            flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none;
            -webkit-overflow-scrolling: touch;
        }
        .log-item {
            padding: 8px 15px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; color: #ccc; font-size: 0.9rem;
        }
        .log-head { background: #333; color: #aaa; padding: 5px 10px; font-size: 0.8rem; }

        /* --- ÁâπÊïà --- */
        .hit-fx {
            position: fixed; pointer-events: none;
            font-size: 3rem; font-weight: 900;
            text-shadow: 0 2px 5px #000;
            z-index: 100;
            animation: popUp 0.5s ease-out forwards;
        }
        @keyframes popUp { 0%{opacity:0;transform:translate(-50%,-50%) scale(0.5);} 50%{opacity:1;transform:translate(-50%,-100%) scale(1.2);} 100%{opacity:0;transform:translate(-50%,-150%) scale(1);} }

        /* --- È†ÅÈù¢ --- */
        #setup-screen, #winner-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #1a1a1a; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }
        
        .setup-btn { 
            background:#444; color:#fff; border:none; 
            padding:12px 24px; margin:5px; border-radius:8px; font-size:1.1rem; 
            cursor: pointer;
        }
        .setup-btn.sel { 
            background:#27ae60; font-weight:bold; 
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }
        .start-btn { 
            background:#c0392b; color:#fff; border:none; 
            padding:15px 50px; border-radius:50px; font-size:1.5rem; margin-top:30px; 
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(192, 57, 43, 0.4);
        }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1 style="color:#fff; font-size: 3rem; margin-bottom: 20px;">üéØ È£õÈè¢Ë®àÂàÜ</h1>
        <div style="text-align:center; margin-bottom:30px;">
            <p style="color:#888; margin-bottom: 10px;">ÁõÆÊ®ôÂàÜÊï∏</p>
            <div id="opt-target">
                <button class="setup-btn sel" data-val="301">301</button>
                <button class="setup-btn" data-val="501">501</button>
                <button class="setup-btn" data-val="701">701</button>
            </div>
        </div>
        <div style="text-align:center; margin-bottom:30px;">
            <p style="color:#888; margin-bottom: 10px;">Áé©ÂÆ∂‰∫∫Êï∏</p>
            <div id="opt-players">
                <button class="setup-btn" data-val="1">1‰∫∫</button>
                <button class="setup-btn sel" data-val="2">2‰∫∫</button>
                <button class="setup-btn" data-val="3">3‰∫∫</button>
                <button class="setup-btn" data-val="4">4‰∫∫</button>
            </div>
        </div>
        <button class="start-btn" id="btn-start-game">ÈñãÂßãÈÅäÊà≤</button>
        <p style="color:#555; font-size: 0.8rem; margin-top: 10px;">(Èü≥ÊïàÂèØÊñºÈÅäÊà≤‰∏≠ÈñãÈóú)</p>
    </div>

    <div id="game-screen" class="hidden">
        <div class="top-bar">
            <span class="round-txt">Round <span id="lbl-round">1</span></span>
            <div style="display:flex; align-items:center;">
                <button id="btn-sound" onclick="toggleSound()">üîä</button>
                <button class="btn-ctrl" onclick="undo()" style="margin-right:5px;">ÊÇîÊ£ã</button>
                <button class="btn-ctrl" onclick="location.reload()" style="background:#c0392b;">ÈáçÁΩÆ</button>
            </div>
        </div>

        <div class="scoreboard" id="score-container"></div>

        <div id="board-area">
            <div id="board-container">
                <svg id="svg-board" viewBox="-225 -225 450 450"></svg>
                <div id="touch-layer"></div>
            </div>
            <div class="btn-out-wrap">
                <button id="btn-out">MISS / OUT</button>
            </div>
        </div>

        <div class="log-panel">
            <div class="log-head">Á¥ÄÈåÑ</div>
            <ul class="log-list" id="log-list"></ul>
        </div>
    </div>

    <div id="winner-screen" class="hidden">
        <h1 style="color:gold; font-size:3rem;">WINNER!</h1>
        <h2 id="lbl-winner" style="color:#fff;">Player 1</h2>
        <button class="start-btn" onclick="location.reload()">ÂÜçÁé©‰∏ÄÂ±ÄÔºåËπ¶Ëπ¶ÂéªÁµ¶ÁãóÂππ</button>
    </div>

    <script>
        // --- Ê†∏ÂøÉËÆäÊï∏ (‰ΩøÁî®ÊúÄÁ©©ÂÆöÁöÑ dart10.html Êû∂Êßã) ---
        let cfg = { target: 301, players: 2 };
        let state = {
            players: [], idx: 0, round: 1, darts: 0,
            rScores: [], rValues: [], history: []
        };
        let isLock = false; // ‰ΩøÁî®Á∞°ÂñÆÈéñÂÆöÔºå‰∏çÊêûË§áÈõúÊ™¢Êü•
        
        let audioCtx = null; 
        let isSoundOn = true;

        const ORDER = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
        const R = { out: 220, dout: 170, din: 140, tout: 110, tin: 80, bull: 32 };

        // --- ÂàùÂßãÂåñ ---
        window.onload = function() {
            const bindOpts = (id, key) => {
                const btns = document.querySelectorAll(`#${id} button`);
                btns.forEach(btn => {
                    btn.onclick = function() {
                        btns.forEach(b => b.classList.remove('sel'));
                        this.classList.add('sel');
                        cfg[key] = parseInt(this.dataset.val);
                    };
                });
            };
            bindOpts('opt-target', 'target');
            bindOpts('opt-players', 'players');
            document.getElementById('btn-start-game').onclick = startGame;
        };

        // --- Èü≥ÊïàÁ≥ªÁµ± ---
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('btn-sound');
            if(isSoundOn) {
                btn.innerText = "üîä";
                btn.classList.remove('off');
                if (!audioCtx) initAudio();
                if (audioCtx.state === 'suspended') audioCtx.resume();
            } else {
                btn.innerText = "üîá";
                btn.classList.add('off');
            }
        }

        function playSound(type) {
            if (!isSoundOn) return;
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});

            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                const now = audioCtx.currentTime;
                
                let freq=600, endFreq=100, typeW='triangle';
                if (type==='double'||type==='treble') { freq=1000; endFreq=600; typeW='sine'; }
                else if (type==='bull') { freq=200; endFreq=600; typeW='square'; }
                else if (type==='miss') { freq=100; endFreq=50; typeW='sawtooth'; }

                osc.type = typeW;
                osc.frequency.setValueAtTime(freq, now);
                osc.frequency.linearRampToValueAtTime(endFreq, now + 0.15);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            } catch(e) { }
        }

        // --- ÈÅäÊà≤ÈÇèËºØ ---
        function startGame() {
            initAudio(); 
            const sc = document.getElementById('score-container');
            sc.innerHTML = '';
            state.players = [];
            
            for(let i=0; i<cfg.players; i++) {
                // ÂàùÂßãÂåñ temp = targetÔºåÁ¢∫‰øù Bust ÈÇÑÂéüÊúâÂÄº
                state.players.push({ id:i, score:cfg.target, temp:cfg.target });
                
                let d = document.createElement('div');
                d.className = `p-card ${i===0?'active':''}`;
                d.id = `p-${i}`; // ‰øÆÊ≠£ ID
                d.innerHTML = `<div style="font-size:0.8rem;color:#888;">P${i+1}</div><div class="p-score" id="s-${i}">${cfg.target}</div><div class="p-darts" id="d-${i}"></div>`;
                sc.appendChild(d);
            }
            
            state.idx=0; state.round=1; state.darts=0; 
            state.rScores=[]; state.rValues=[]; state.history=[];
            isLock=false;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            drawVisualBoard();
            initTouchEvents();
        }

        function drawVisualBoard() {
            const svg = document.getElementById('svg-board');
            let h = "";
            for(let i=0; i<20; i++) {
                let ang = -90 + i*18;
                let num = ORDER[i];
                let c1 = i%2===0 ? '#111' : '#e0e0e0';
                let c2 = i%2===0 ? '#c0392b' : '#27ae60';
                h += createPath(ang, R.din, R.dout, c2); 
                h += createPath(ang, R.tout, R.din, c1); 
                h += createPath(ang, R.tin, R.tout, c2); 
                h += createPath(ang, R.bull, R.tin, c1); 
                let rad = ang * Math.PI/180;
                let tx = Math.cos(rad)*190;
                let ty = Math.sin(rad)*190 + 6;
                h += `<text x="${tx}" y="${ty}" text-anchor="middle" fill="#fff" font-weight="bold" font-size="24">${num}</text>`;
            }
            h += `<circle cx="0" cy="0" r="${R.bull}" fill="#27ae60" stroke="#ddd" />`;
            h += `<circle cx="0" cy="0" r="14" fill="#c0392b" stroke="none" />`;
            svg.innerHTML = h;
        }

        function createPath(ang, rIn, rOut, col) {
            let a1 = (ang-9)*Math.PI/180, a2 = (ang+9)*Math.PI/180;
            let d = `M ${Math.cos(a1)*rOut} ${Math.sin(a1)*rOut} A ${rOut} ${rOut} 0 0 1 ${Math.cos(a2)*rOut} ${Math.sin(a2)*rOut} L ${Math.cos(a2)*rIn} ${Math.sin(a2)*rIn} A ${rIn} ${rIn} 0 0 0 ${Math.cos(a1)*rIn} ${Math.sin(a1)*rIn} Z`;
            return `<path d="${d}" fill="${col}" stroke="#888" stroke-width="1" />`;
        }

        function initTouchEvents() {
            const pad = document.getElementById('touch-layer');
            const btnOut = document.getElementById('btn-out');

            const handleInput = (e) => {
                if(e.type === 'touchstart') e.preventDefault();
                if(isSoundOn && audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

                if(isLock || state.darts >= 3) return;

                let clientX, clientY;
                if(e.changedTouches && e.changedTouches.length > 0) {
                    clientX = e.changedTouches[0].clientX;
                    clientY = e.changedTouches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                const rect = pad.getBoundingClientRect();
                const x = clientX - rect.left - rect.width/2;
                const y = clientY - rect.top - rect.height/2;
                calculateScore(x, y, clientX, clientY);
            };

            pad.addEventListener('touchstart', handleInput, {passive:false});
            pad.addEventListener('mousedown', handleInput);

            const handleOut = (e) => {
                if(e.type === 'touchstart') e.preventDefault();
                if(isSoundOn && audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
                if(isLock || state.darts >= 3) return;
                processHit(0, 0, "MISS", null);
            };
            btnOut.addEventListener('touchstart', handleOut, {passive:false});
            btnOut.addEventListener('mousedown', handleOut);
            btnOut.addEventListener('click', (e)=>e.preventDefault());
        }

        function calculateScore(x, y, absX, absY) {
            const container = document.getElementById('board-container');
            const scale = 450 / container.offsetWidth;
            const r = Math.sqrt(x*x + y*y) * scale;
            const deg = Math.atan2(y, x) * 180 / Math.PI;

            let val = 0, mult = 1, type = 'single';
            
            if (r < R.bull) {
                val = 50; type = 'bull';
            } else if (r > R.dout) {
                processHit(0, 0, "MISS", {x:absX, y:absY});
                return;
            } else {
                if (r >= R.bull && r < R.tin) { mult = 1; type = 'single'; }
                else if (r >= R.tin && r < R.tout) { mult = 3; type = 'treble'; }
                else if (r >= R.tout && r < R.din) { mult = 1; type = 'single'; }
                else if (r >= R.din && r <= R.dout) { mult = 2; type = 'double'; }

                let angleIndex = Math.floor((deg + 90 + 9 + 360) % 360 / 18) % 20;
                val = ORDER[angleIndex];
            }
            processHit(val, mult, null, {x:absX, y:absY}, type);
        }

        // --- Ê†∏ÂøÉËôïÁêÜ (‰øÆÂæ© BUST È°ØÁ§∫) ---
        function processHit(val, mult, forceText, pos, soundType) {
            if(isLock) return;
            isLock = true;
            setTimeout(() => isLock=false, 250);

            if(forceText === "MISS") playSound('miss');
            else if(soundType) playSound(soundType);

            const p = state.players[state.idx];
            const points = val * mult;
            let txt = forceText ? forceText : (val===50?"BULL":(mult===3?"T"+val:(mult===2?"D"+val:val)));
            
            if(pos) showFx(txt, pos.x, pos.y, val, mult);

            state.history.push({
                idx: state.idx, 
                prevScore: p.score, 
                temp: p.temp, 
                r: state.round, 
                d: state.darts,
                rs: [...state.rScores], 
                rv: [...state.rValues]
            });

            let newScore = p.score - points;
            
            if(newScore < 0) {
                // BUST
                state.rScores.push("BUST");
                playSound('miss');
                showToast("BUST!");
                
                // [ÈóúÈçµ‰øÆÂæ©]
                p.score = p.temp; // ÈÇÑÂéüÂàÜÊï∏
                updateUI();       // Á´ãÂç≥Êõ¥Êñ∞ UIÔºåËÆìÂ§ßÂàÜÊï∏Ë∑≥ÂõûÂéªÔºÅ
                
                setTimeout(() => nextTurn(true), 1000);

            } else if(newScore === 0) {
                // WIN
                p.score = 0;
                updateUI();
                playSound('bull');
                document.getElementById('lbl-winner').innerText = `Player ${state.idx+1}`;
                document.getElementById('winner-screen').classList.remove('hidden');

            } else {
                // NORMAL
                p.score = newScore;
                state.rScores.push(txt);
                state.rValues.push(points);
                state.darts++;
                updateUI();

                if(state.darts >= 3) {
                    setTimeout(() => nextTurn(false), 300);
                }
            }
        }

        function nextTurn(isBust) {
            const p = state.players[state.idx];
            let drop = isBust ? 0 : (p.temp - p.score);
            log(`P${state.idx+1}: [${state.rScores.join(',')}] -${drop} ‚Üí ${p.score}`);
            
            p.temp = p.score; // ÈéñÂÆö‰∏ãÂõûÂêàËµ∑ÂßãÂàÜ

            state.darts = 0; 
            state.rScores = []; 
            state.rValues = [];
            
            // [ÈóúÈçµ ID] ‰ΩøÁî® p-{idx} ËÄåÈùû card-{idx}
            document.getElementById(`p-${state.idx}`).classList.remove('active');
            state.idx++;
            if(state.idx >= cfg.players) {
                state.idx = 0;
                state.round++;
                log(`--- Round ${state.round} ---`, true);
            }
            document.getElementById(`p-${state.idx}`).classList.add('active');
            updateUI();
            isLock = false;
        }

        function undo() {
            if(state.history.length===0 || isLock) return;
            let h = state.history.pop();
            
            if(h.idx !== state.idx) {
                document.getElementById(`p-${state.idx}`).classList.remove('active');
                state.idx = h.idx; state.round = h.r;
                document.getElementById(`p-${state.idx}`).classList.add('active');
                let ul = document.getElementById('log-list');
                if(ul.lastChild) ul.removeChild(ul.lastChild);
                if(ul.lastChild && ul.lastChild.classList.contains('log-head')) ul.removeChild(ul.lastChild);
            }

            let p = state.players[h.idx];
            p.score = h.prevScore;
            if (h.temp !== undefined) p.temp = h.temp;
            
            state.darts = h.d;
            state.rScores = h.rs;
            state.rValues = h.rv;
            updateUI();
        }

        function updateUI() {
            state.players.forEach(pp => document.getElementById(`s-${pp.id}`).innerText = pp.score);
            document.getElementById('lbl-round').innerText = state.round;
            
            // [ÈóúÈçµ ID] ‰ΩøÁî® d-{idx} Á¢∫‰øùÊäìÂæóÂà∞ÂÖÉÁ¥†
            const dartEl = document.getElementById('d-'+state.idx);
            if(dartEl) dartEl.innerText = state.rScores.join(' ');
        }

        function showFx(txt, x, y, val, mult) {
            let d = document.createElement('div');
            d.className = 'hit-fx';
            d.innerText = txt;
            d.style.left = x + 'px';
            d.style.top = y + 'px';
            d.style.color = (val===50?"#2ecc71":(mult===3?"#c0392b":(mult===2?"#f1c40f":"#fff")));
            document.body.appendChild(d);
            setTimeout(()=>d.remove(), 500);
        }

        function showToast(msg) {
            let d = document.createElement('div');
            d.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:#e74c3c;font-size:3rem;font-weight:bold;padding:20px;border:2px solid #e74c3c;border-radius:10px;z-index:200;";
            d.innerText = msg;
            document.body.appendChild(d);
            setTimeout(()=>d.remove(), 1000);
        }

        function log(msg, isHead) {
            let ul = document.getElementById('log-list');
            let li = document.createElement('li');
            if(isHead) {
                li.className = 'log-head';
                li.innerText = msg;
            } else {
                li.className = 'log-item';
                li.innerText = msg;
            }
            ul.appendChild(li);
            ul.scrollTop = ul.scrollHeight;
        }

    </script>
</body>
</html>
