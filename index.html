<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>é£›é¢è¨ˆåˆ† (v5.0 Bugä¿®æ­£ç‰ˆ)</title>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ecf0f1;
            margin: 0;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- é ‚éƒ¨è³‡è¨Šåˆ— --- */
        .top-bar {
            flex: 0 0 50px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 10;
        }
        .btn-ctrl {
            background: #505050; border: none; color: #fff;
            padding: 8px 16px; border-radius: 6px; font-size: 0.9rem;
            cursor: pointer;
        }
        .round-txt { color: #f1c40f; font-weight: bold; font-size: 1.1rem; }

        /* --- åˆ†æ•¸æ¿ --- */
        .scoreboard {
            flex: 0 0 auto;
            background: #1a1a1a;
            padding: 10px;
            display: flex;
            gap: 5px;
            overflow-x: auto;
        }
        .p-card {
            flex: 1;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 5px;
            text-align: center;
            opacity: 0.5;
            min-width: 60px;
            transition: 0.2s;
        }
        .p-card.single-mode { max-width: 200px; margin: 0 auto; }
        .p-card.active {
            opacity: 1;
            background: #3e3e3e;
            border-color: #f1c40f;
            transform: scale(1.02);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .p-score { font-size: 1.8rem; font-weight: bold; margin: 2px 0; }
        .p-darts { color: #f1c40f; font-size: 0.7rem; height: 1em; }

        /* --- é£›é¢ç›¤å€åŸŸ --- */
        #board-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(#222, #111);
            overflow: hidden;
            touch-action: none; 
        }

        #board-container {
            position: relative;
            width: 340px; height: 340px;
            max-width: 90vmin; max-height: 90vmin;
        }

        /* è¦–é‡ç¯„åœç¶­æŒ 450 (MISSå€åŠ å¤§) */
        svg {
            width: 100%; height: 100%;
            pointer-events: none;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.6));
        }

        #touch-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 50; cursor: crosshair;
        }

        .btn-out-wrap { margin-top: 15px; z-index: 60; }
        #btn-out {
            background: #34495e; color: #ccc;
            border: 2px solid #555;
            padding: 15px 60px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
        }
        #btn-out:active { background: #c0392b; color: #fff; border-color: #e74c3c; }

        /* --- æ­·å²ç´€éŒ„ --- */
        .log-panel {
            flex: none;
            height: 25vh;
            min-height: 150px;
            background: #1e1e1e;
            border-top: 2px solid #f1c40f;
            display: flex; flex-direction: column;
            z-index: 20;
        }
        .log-list {
            flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none;
            -webkit-overflow-scrolling: touch;
        }
        .log-item {
            padding: 10px 15px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; color: #ccc; font-size: 0.9rem;
        }
        .log-head { background: #333; color: #aaa; padding: 5px 10px; font-size: 0.8rem; }

        /* --- ç‰¹æ•ˆ --- */
        .hit-fx {
            position: fixed; pointer-events: none;
            font-size: 3rem; font-weight: 900;
            text-shadow: 0 2px 5px #000;
            z-index: 100;
            animation: popUp 0.5s ease-out forwards;
        }
        @keyframes popUp { 0%{opacity:0;transform:translate(-50%,-50%) scale(0.5);} 50%{opacity:1;transform:translate(-50%,-100%) scale(1.2);} 100%{opacity:0;transform:translate(-50%,-150%) scale(1);} }

        /* --- é é¢ --- */
        #setup-screen, #winner-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #1a1a1a; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }
        
        .setup-btn { 
            background:#444; color:#fff; border:none; 
            padding:12px 24px; margin:5px; border-radius:8px; font-size:1.1rem; 
            cursor: pointer;
        }
        .setup-btn.sel { 
            background:#27ae60; font-weight:bold; 
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }
        .start-btn { 
            background:#c0392b; color:#fff; border:none; 
            padding:15px 50px; border-radius:50px; font-size:1.5rem; margin-top:30px; 
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(192, 57, 43, 0.4);
        }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1 style="color:#fff; font-size: 3rem; margin-bottom: 20px;">ğŸ¯ é£›é¢è¨ˆåˆ†</h1>
        
        <div style="text-align:center; margin-bottom:30px;">
            <p style="color:#888; margin-bottom: 10px;">ç›®æ¨™åˆ†æ•¸</p>
            <div id="opt-target">
                <button class="setup-btn sel" data-val="301">301</button>
                <button class="setup-btn" data-val="501">501</button>
                <button class="setup-btn" data-val="701">701</button>
            </div>
        </div>
        
        <div style="text-align:center; margin-bottom:30px;">
            <p style="color:#888; margin-bottom: 10px;">ç©å®¶äººæ•¸</p>
            <div id="opt-players">
                <button class="setup-btn" data-val="1">1äºº</button>
                <button class="setup-btn sel" data-val="2">2äºº</button>
                <button class="setup-btn" data-val="3">3äºº</button>
                <button class="setup-btn" data-val="4">4äºº</button>
            </div>
        </div>

        <button class="start-btn" id="btn-start-game">é–‹å§‹éŠæˆ²</button>
        <p style="color:#555; font-size: 0.8rem; margin-top: 10px;">(éŸ³æ•ˆéœ€åœ¨éœéŸ³æ¨¡å¼é—œé–‰æ™‚æ’­æ”¾)</p>
    </div>

    <div id="game-screen" class="hidden">
        <div class="top-bar">
            <span class="round-txt">Round <span id="lbl-round">1</span></span>
            <div>
                <button class="btn-ctrl" onclick="undo()">æ‚”æ£‹</button>
                <button class="btn-ctrl" onclick="location.reload()" style="background:#c0392b; margin-left:5px;">é‡ç½®</button>
            </div>
        </div>

        <div class="scoreboard" id="score-container"></div>

        <div id="board-area">
            <div id="board-container">
                <svg id="svg-board" viewBox="-225 -225 450 450"></svg>
                <div id="touch-layer"></div>
            </div>
            
            <div class="btn-out-wrap">
                <button id="btn-out">MISS / OUT</button>
            </div>
        </div>

        <div class="log-panel">
            <div class="log-head">ç´€éŒ„</div>
            <ul class="log-list" id="log-list"></ul>
        </div>
    </div>

    <div id="winner-screen" class="hidden">
        <h1 style="color:gold; font-size:3rem;">WINNER!</h1>
        <h2 id="lbl-winner" style="color:#fff;">Player 1</h2>
        <button class="start-btn" onclick="location.reload()">å†ç©ä¸€å±€</button>
    </div>

    <script>
        // --- è¨­å®šèˆ‡ç‹€æ…‹ ---
        let cfg = { target: 301, players: 2 };
        let state = {
            players: [], idx: 0, round: 1, darts: 0,
            rScores: [], rValues: [], history: []
        };
        let isLock = false;
        let audioCtx = null; 

        const ORDER = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];

        // --- åŠ å¤§ç‰ˆå¹¾ä½•è¨­å®š (Fat Rings + Large Miss) ---
        const R = { 
            out: 220,   // MISS é‚Šç•Œ
            dout: 170,  // é›™å€å¤–
            din: 140,   // é›™å€å…§
            tout: 110,  // ä¸‰å€å¤–
            tin: 80,    // ä¸‰å€å…§
            bull: 32    // ç´…å¿ƒ
        };

        window.onload = function() {
            const targetBtns = document.querySelectorAll('#opt-target button');
            targetBtns.forEach(btn => {
                btn.onclick = function() {
                    targetBtns.forEach(b => b.classList.remove('sel'));
                    this.classList.add('sel');
                    cfg.target = parseInt(this.dataset.val);
                };
            });

            const playerBtns = document.querySelectorAll('#opt-players button');
            playerBtns.forEach(btn => {
                btn.onclick = function() {
                    playerBtns.forEach(b => b.classList.remove('sel'));
                    this.classList.add('sel');
                    cfg.players = parseInt(this.dataset.val);
                };
            });

            document.getElementById('btn-start-game').onclick = startGame;
        };

        // --- éŸ³æ•ˆç³»çµ± (ä¿®æ­£ï¼šè‡ªå‹•å–šé†’æ©Ÿåˆ¶) ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // é—œéµä¿®æ­£ï¼šæ¯æ¬¡äº’å‹•éƒ½æª¢æŸ¥éŸ³æ•ˆå¼•æ“æ˜¯å¦æ›äº†ï¼Œæ›äº†å°±å«é†’
        function checkAudio() {
            if (audioCtx && (audioCtx.state === 'suspended' || audioCtx.state === 'interrupted')) {
                audioCtx.resume();
            }
        }

        function playSound(type) {
            checkAudio(); // ç¢ºä¿æ’­æ”¾å‰å¼•æ“æ˜¯æ´»çš„
            if (!audioCtx) return;

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'single') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'double' || type === 'treble') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1000, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.2);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'bull') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(600, now + 0.15);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'miss') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }

        function startGame() {
            initAudio();

            const sc = document.getElementById('score-container');
            sc.innerHTML = '';
            state.players = [];
            
            const isSingle = cfg.players === 1;

            // ä¿®æ­£ï¼šæ¯å€‹ç©å®¶ç‰©ä»¶éƒ½å¢åŠ  startScore å±¬æ€§ (å›åˆèµ·å§‹åˆ†æ•¸)
            for(let i=0; i<cfg.players; i++) {
                state.players.push({ 
                    id:i, 
                    score:cfg.target, 
                    startScore:cfg.target // é—œéµï¼šé€™æ˜¯è©²å›åˆé–‹å§‹å‰çš„åˆ†æ•¸
                });
                
                let d = document.createElement('div');
                d.className = `p-card ${i===0?'active':''} ${isSingle?'single-mode':''}`;
                d.id = `p-${i}`;
                d.innerHTML = `<div style="font-size:0.8rem;color:#888;">P${i+1}</div><div class="p-score" id="s-${i}">${cfg.target}</div><div class="p-darts" id="d-${i}"></div>`;
                sc.appendChild(d);
            }
            
            state.idx=0; state.round=1; state.darts=0; 
            state.rScores=[]; state.rValues=[]; state.history=[];
            isLock=false;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            drawVisualBoard();
            initTouchEvents();
        }

        function drawVisualBoard() {
            const svg = document.getElementById('svg-board');
            let h = "";
            
            for(let i=0; i<20; i++) {
                let ang = -90 + i*18;
                let num = ORDER[i];
                let c1 = i%2===0 ? '#111' : '#e0e0e0';
                let c2 = i%2===0 ? '#c0392b' : '#27ae60';
                
                h += createPath(ang, R.din, R.dout, c2); 
                h += createPath(ang, R.tout, R.din, c1); 
                h += createPath(ang, R.tin, R.tout, c2); 
                h += createPath(ang, R.bull, R.tin, c1); 

                let rad = ang * Math.PI/180;
                let tx = Math.cos(rad)*190;
                let ty = Math.sin(rad)*190 + 6;
                h += `<text x="${tx}" y="${ty}" text-anchor="middle" fill="#fff" font-weight="bold" font-size="24">${num}</text>`;
            }
            h += `<circle cx="0" cy="0" r="${R.bull}" fill="#27ae60" stroke="#ddd" />`;
            h += `<circle cx="0" cy="0" r="14" fill="#c0392b" stroke="none" />`;
            
            svg.innerHTML = h;
        }

        function createPath(ang, rIn, rOut, col) {
            let a1 = (ang-9)*Math.PI/180;
            let a2 = (ang+9)*Math.PI/180;
            let d = `M ${Math.cos(a1)*rOut} ${Math.sin(a1)*rOut} A ${rOut} ${rOut} 0 0 1 ${Math.cos(a2)*rOut} ${Math.sin(a2)*rOut} L ${Math.cos(a2)*rIn} ${Math.sin(a2)*rIn} A ${rIn} ${rIn} 0 0 0 ${Math.cos(a1)*rIn} ${Math.sin(a1)*rIn} Z`;
            return `<path d="${d}" fill="${col}" stroke="#888" stroke-width="1" />`;
        }

        function initTouchEvents() {
            const pad = document.getElementById('touch-layer');
            const btnOut = document.getElementById('btn-out');

            const handleInput = (e) => {
                if(e.type === 'touchstart') e.preventDefault();
                checkAudio(); // æ¯æ¬¡é»æ“Šéƒ½æª¢æŸ¥éŸ³æ•ˆ

                if(isLock || state.darts >= 3) return;

                let clientX, clientY;
                if(e.changedTouches && e.changedTouches.length > 0) {
                    clientX = e.changedTouches[0].clientX;
                    clientY = e.changedTouches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                const rect = pad.getBoundingClientRect();
                const x = clientX - rect.left - rect.width/2;
                const y = clientY - rect.top - rect.height/2;

                calculateScore(x, y, clientX, clientY);
            };

            pad.addEventListener('touchstart', handleInput, {passive:false});
            pad.addEventListener('mousedown', handleInput);

            // OUT æŒ‰éˆ•
            const handleOut = (e) => {
                if(e.type === 'touchstart') e.preventDefault();
                checkAudio(); // æ¯æ¬¡é»æ“Šéƒ½æª¢æŸ¥éŸ³æ•ˆ
                processHit(0, 0, "MISS", null);
            };
            btnOut.addEventListener('touchstart', handleOut, {passive:false});
            btnOut.addEventListener('mousedown', handleOut);
            btnOut.addEventListener('click', (e)=>e.preventDefault());
        }

        function calculateScore(x, y, absX, absY) {
            const container = document.getElementById('board-container');
            const scale = 450 / container.offsetWidth;
            
            const r = Math.sqrt(x*x + y*y) * scale;
            const deg = Math.atan2(y, x) * 180 / Math.PI;

            let val = 0, mult = 1;
            let soundType = 'single';
            
            if (r < R.bull) {
                val = 50; mult = 1; soundType = 'bull';
            } else if (r > R.dout) {
                processHit(0, 0, "MISS", {x:absX, y:absY});
                return;
            } else {
                if (r >= R.bull && r < R.tin) { mult = 1; soundType = 'single'; }
                else if (r >= R.tin && r < R.tout) { mult = 3; soundType = 'treble'; }
                else if (r >= R.tout && r < R.din) { mult = 1; soundType = 'single'; }
                else if (r >= R.din && r <= R.dout) { mult = 2; soundType = 'double'; }

                let angleIndex = Math.floor((deg + 90 + 9 + 360) % 360 / 18);
                angleIndex = angleIndex % 20;
                val = ORDER[angleIndex];
            }

            processHit(val, mult, null, {x:absX, y:absY}, soundType);
        }

        function processHit(val, mult, forceText, pos, soundType) {
            if(isLock) return;
            isLock = true;
            setTimeout(() => isLock=false, 250);

            if(forceText === "MISS") playSound('miss');
            else if(soundType) playSound(soundType);

            const p = state.players[state.idx];
            const points = val * mult;
            let txt = forceText ? forceText : (val===50?"BULL":(mult===3?"T"+val:(mult===2?"D"+val:val)));
            
            if(pos) showFx(txt, pos.x, pos.y, val, mult);

            // ç´€éŒ„æ­·å² (é—œéµä¿®æ­£ï¼šåŠ å…¥ startScore å‚™ä»½)
            state.history.push({
                idx: state.idx, 
                prevScore: p.score,      // æŠ•æ“²å‰åˆ†æ•¸
                startScore: p.startScore,// è©²å›åˆèµ·å§‹åˆ†æ•¸ (ç”¨æ–¼æ‚”æ£‹é‚„åŸ)
                r: state.round, 
                d: state.darts,
                rs: [...state.rScores], 
                rv: [...state.rValues]
            });

            let newScore = p.score - points;
            
            // --- çˆ†åˆ† (BUST) é‚è¼¯ä¿®æ­£ ---
            if(newScore < 0) {
                state.rScores.push("BUST");
                playSound('miss');
                showToast("BUST!");
                
                // ä¿®æ­£ï¼šå›åˆ° startScore (å›åˆèµ·å§‹åˆ†)ï¼Œè€Œä¸æ˜¯å›åˆ°ä¸Šä¸€é¢çš„åˆ†æ•¸
                p.score = p.startScore;
                
                setTimeout(() => nextTurn(true), 1000);
            } else if(newScore === 0) {
                p.score = 0;
                updateUI();
                playSound('bull');
                document.getElementById('lbl-winner').innerText = `Player ${state.idx+1}`;
                document.getElementById('winner-screen').classList.remove('hidden');
            } else {
                p.score = newScore;
                state.rScores.push(txt);
                state.rValues.push(points);
                state.darts++;
                updateUI();

                if(state.darts >= 3) {
                    setTimeout(() => nextTurn(false), 300);
                }
            }
        }

        function nextTurn(isBust) {
            const p = state.players[state.idx];
            // çˆ†åˆ†é¡¯ç¤ºæ‰£0åˆ†ï¼Œå¦å‰‡é¡¯ç¤ºå¯¦éš›æ‰£åˆ†
            let drop = isBust ? 0 : (p.startScore - p.score);
            log(`P${state.idx+1}: [${state.rScores.join(',')}] -${drop} â†’ ${p.score}`);
            
            // é–å®šåˆ†æ•¸ï¼šé€™ä¸€å›åˆçµæŸï¼Œç›®å‰åˆ†æ•¸æˆç‚ºä¸‹ä¸€å›åˆçš„èµ·å§‹åˆ†
            p.startScore = p.score;

            state.darts = 0; 
            state.rScores = []; 
            state.rValues = [];
            
            document.getElementById(`card-${state.idx}`).classList.remove('active');
            state.idx++;
            if(state.idx >= cfg.players) {
                state.idx = 0;
                state.round++;
                log(`--- Round ${state.round} ---`, true);
            }
            document.getElementById(`card-${state.idx}`).classList.add('active');
            updateUI();
            isLock = false;
        }

        function undo() {
            if(state.history.length===0 || isLock) return;
            let h = state.history.pop();
            
            // å¦‚æœæ‚”æ£‹è·¨è¶Šäº†ç©å®¶ (å›åˆ°ä¸Šä¸€äºº)
            if(h.idx !== state.idx) {
                document.getElementById(`card-${state.idx}`).classList.remove('active');
                state.idx = h.idx; 
                state.round = h.r;
                document.getElementById(`card-${state.idx}`).classList.add('active');
                let list = document.getElementById('log-list');
                if(list.lastChild) list.removeChild(list.lastChild);
            }

            let p = state.players[h.idx];
            
            // é‚„åŸç‹€æ…‹
            p.score = h.prevScore;      // é‚„åŸåˆ†æ•¸
            p.startScore = h.startScore; // é—œéµä¿®æ­£ï¼šé‚„åŸå›åˆèµ·å§‹åˆ†æ•¸ (é˜²æ­¢çˆ†åˆ†åˆ¤å®šéŒ¯èª¤)
            
            state.darts = h.d;
            state.rScores = h.rs;
            state.rValues = h.rv;
            updateUI();
        }

        function updateUI() {
            state.players.forEach(pp => document.getElementById(`s-${pp.id}`).innerText = pp.score);
            document.getElementById('lbl-round').innerText = state.round;
            document.getElementById(`darts-${state.idx}`).innerText = state.rScores.join(' ');
        }

        function showFx(txt, x, y, val, mult) {
            let d = document.createElement('div');
            d.className = 'hit-fx';
            d.innerText = txt;
            d.style.left = x + 'px';
            d.style.top = y + 'px';
            d.style.color = (val===50?"#2ecc71":(mult===3?"#c0392b":(mult===2?"#f1c40f":"#fff")));
            document.body.appendChild(d);
            setTimeout(()=>d.remove(), 500);
        }

        function showToast(msg) {
            let d = document.createElement('div');
            d.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:#e74c3c;font-size:3rem;font-weight:bold;padding:20px;border:2px solid #e74c3c;border-radius:10px;z-index:200;";
            d.innerText = msg;
            document.body.appendChild(d);
            setTimeout(()=>d.remove(), 1000);
        }

        function log(msg, isHead) {
            let ul = document.getElementById('log-list');
            let li = document.createElement('li');
            if(isHead) {
                li.className = 'log-head';
                li.innerText = msg;
            } else {
                li.className = 'log-item';
                li.innerText = msg;
            }
            ul.appendChild(li);
            ul.parentElement.scrollTop = ul.parentElement.scrollHeight;
        }

    </script>
</body>
</html>
