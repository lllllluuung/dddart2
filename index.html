<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£›é¢è¨ˆåˆ† (åº§æ¨™æ¼”ç®—ç‰ˆ)</title>
    <style>
        /* --- å…¨åŸŸé‡ç½® --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation; /* å…è¨±é»æ“Šï¼Œç¦æ­¢é›™æ“Šç¸®æ”¾ */
        }

        body {
            font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ecf0f1;
            margin: 0;
            height: 100dvh; /* iOS Full Height */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- é ‚éƒ¨è³‡è¨Šåˆ— --- */
        .top-bar {
            flex: 0 0 50px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 10;
        }
        .btn-ctrl {
            background: #505050; border: none; color: #fff;
            padding: 8px 12px; border-radius: 4px; font-size: 0.9rem;
        }
        .round-txt { color: #f1c40f; font-weight: bold; font-size: 1.1rem; }

        /* --- åˆ†æ•¸æ¿ --- */
        .scoreboard {
            flex: 0 0 auto;
            background: #1a1a1a;
            padding: 10px;
            display: flex;
            gap: 5px;
            overflow-x: auto;
        }
        .p-card {
            flex: 1;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 5px;
            text-align: center;
            opacity: 0.5;
            min-width: 60px;
            transition: 0.2s;
        }
        .p-card.active {
            opacity: 1;
            background: #3e3e3e;
            border-color: #f1c40f;
            transform: scale(1.02);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .p-score { font-size: 1.8rem; font-weight: bold; margin: 2px 0; }
        .p-darts { color: #f1c40f; font-size: 0.7rem; height: 1em; }

        /* --- é£›é¢ç›¤å€åŸŸ (é—œéµä¿®æ­£) --- */
        #board-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(#222, #111);
            overflow: hidden;
        }

        #board-container {
            position: relative;
            width: 340px; height: 340px;
            max-width: 90vmin; max-height: 90vmin;
            /* é€™è£¡ä¸è™•ç†äº‹ä»¶ï¼Œäº¤çµ¦ä¸Šé¢çš„é®ç½© */
        }

        svg {
            width: 100%; height: 100%;
            pointer-events: none; /* è®“ SVG ç´”ç²¹åªåšé¡¯ç¤ºï¼Œä¸æ“‹äº‹ä»¶ */
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.6));
        }

        /* --- éš±å½¢è§¸æ§å±¤ (Interaction Layer) --- */
        #touch-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 50; /* åœ¨æœ€ä¸Šå±¤ */
            cursor: crosshair;
            /* é–‹ç™¼ç”¨ï¼šåŠé€æ˜ç´…è‰² debugï¼Œæ­£å¼ç‰ˆæ”¹ç‚º transparent */
            background: transparent; 
        }

        /* --- OUT æŒ‰éˆ• --- */
        .btn-out-wrap {
            margin-top: 15px;
            z-index: 60;
        }
        #btn-out {
            background: #34495e; color: #ccc;
            border: 2px solid #555;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        #btn-out:active { background: #c0392b; color: #fff; border-color: #e74c3c; }

        /* --- æ­·å²ç´€éŒ„ --- */
        .log-panel {
            flex: none;
            height: 25vh;
            min-height: 150px;
            background: #1e1e1e;
            border-top: 2px solid #f1c40f;
            display: flex; flex-direction: column;
            z-index: 20;
        }
        .log-list {
            flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none;
            -webkit-overflow-scrolling: touch;
        }
        .log-item {
            padding: 10px 15px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; color: #ccc; font-size: 0.9rem;
        }
        .log-head { background: #333; color: #aaa; padding: 5px 10px; font-size: 0.8rem; }

        /* --- ç‰¹æ•ˆèˆ‡è¦–çª— --- */
        .hit-fx {
            position: fixed; pointer-events: none;
            font-size: 3rem; font-weight: 900;
            text-shadow: 0 2px 5px #000;
            z-index: 100;
            animation: popUp 0.5s ease-out forwards;
        }
        @keyframes popUp { 0%{opacity:0;transform:translate(-50%,-50%) scale(0.5);} 50%{opacity:1;transform:translate(-50%,-100%) scale(1.2);} 100%{opacity:0;transform:translate(-50%,-150%) scale(1);} }

        #setup-screen, #winner-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #1a1a1a; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }
        
        .setup-btn { background:#444; color:#fff; border:none; padding:10px 20px; margin:5px; border-radius:5px; font-size:1.1rem; }
        .setup-btn.sel { background:#27ae60; font-weight:bold; }
        .start-btn { background:#c0392b; color:#fff; border:none; padding:15px 40px; border-radius:50px; font-size:1.5rem; margin-top:20px; }
        
        /* Debug info */
        #debug-info { position: absolute; top:0; left:0; color: #555; font-size: 10px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="debug-info">Ready</div>

    <div id="setup-screen">
        <h1 style="color:#fff;">ğŸ¯ é£›é¢è¨ˆåˆ†</h1>
        <div style="text-align:center; margin-bottom:20px;">
            <p style="color:#888;">ç›®æ¨™</p>
            <button onclick="setCfg('target',301,this)" class="setup-btn sel">301</button>
            <button onclick="setCfg('target',501,this)" class="setup-btn">501</button>
            <button onclick="setCfg('target',701,this)" class="setup-btn">701</button>
        </div>
        <div style="text-align:center; margin-bottom:20px;">
            <p style="color:#888;">äººæ•¸</p>
            <button onclick="setCfg('players',2,this)" class="setup-btn sel">2äºº</button>
            <button onclick="setCfg('players',3,this)" class="setup-btn">3äºº</button>
            <button onclick="setCfg('players',4,this)" class="setup-btn">4äºº</button>
        </div>
        <button class="start-btn" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="game-screen" class="hidden">
        <div class="top-bar">
            <span class="round-txt">Round <span id="lbl-round">1</span></span>
            <div>
                <button class="btn-ctrl" onclick="undo()">æ‚”æ£‹</button>
                <button class="btn-ctrl" onclick="location.reload()" style="background:#c0392b; margin-left:5px;">é‡ç½®</button>
            </div>
        </div>

        <div class="scoreboard" id="score-container"></div>

        <div id="board-area">
            <div id="board-container">
                <svg id="svg-board" viewBox="-205 -205 410 410"></svg>
                <div id="touch-layer"></div>
            </div>
            
            <div class="btn-out-wrap">
                <button id="btn-out">MISS / OUT</button>
            </div>
        </div>

        <div class="log-panel">
            <div class="log-head">ç´€éŒ„</div>
            <ul class="log-list" id="log-list"></ul>
        </div>
    </div>

    <div id="winner-screen" class="hidden">
        <h1 style="color:gold; font-size:3rem;">WINNER!</h1>
        <h2 id="lbl-winner" style="color:#fff;">Player 1</h2>
        <button class="start-btn" onclick="location.reload()">å†ç©ä¸€å±€</button>
    </div>

    <script>
        // --- è¨­å®šèˆ‡ç‹€æ…‹ ---
        let cfg = { target: 301, players: 2 };
        let state = {
            players: [], idx: 0, round: 1, darts: 0,
            rScores: [], rValues: [], history: []
        };
        let isLock = false;

        // æ¨™æº–é£›é¢ç›¤æ•¸å­—é †åº (å¾ä¸Šæ–¹é–‹å§‹é †æ™‚é‡)
        // æ•¸å­¸è§’åº¦ï¼šä¸Šæ–¹æ˜¯ -90åº¦ (æˆ– 270åº¦)
        const ORDER = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];

        function setCfg(k, v, el) {
            cfg[k] = v;
            el.parentNode.querySelectorAll('button').forEach(b=>b.classList.remove('sel'));
            el.classList.add('sel');
        }

        function startGame() {
            // åˆå§‹åŒ–ç©å®¶
            const sc = document.getElementById('score-container');
            sc.innerHTML = '';
            state.players = [];
            for(let i=0; i<cfg.players; i++) {
                state.players.push({ id:i, score:cfg.target, temp:cfg.target });
                let d = document.createElement('div');
                d.className = `p-card ${i===0?'active':''}`;
                d.id = `p-${i}`;
                d.innerHTML = `<div style="font-size:0.8rem;color:#888;">P${i+1}</div><div class="p-score" id="s-${i}">${cfg.target}</div><div class="p-darts" id="d-${i}"></div>`;
                sc.appendChild(d);
            }
            
            state.idx=0; state.round=1; state.darts=0; 
            state.rScores=[]; state.rValues=[]; state.history=[];
            isLock=false;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            drawVisualBoard();
            initTouchEvents(); // å•Ÿå‹•è§¸æ§ç›£è½
        }

        // --- è¦–è¦ºç¹ªè£½ (åƒ… SVGï¼Œä¸å«äº‹ä»¶) ---
        function drawVisualBoard() {
            const svg = document.getElementById('svg-board');
            let h = "";
            const R = { out: 200, dout: 170, din: 160, tout: 107, tin: 97, bull: 32 };
            
            // ç•«æ‰‡å½¢
            for(let i=0; i<20; i++) {
                let ang = -90 + i*18;
                let num = ORDER[i];
                let c1 = i%2===0 ? '#111' : '#e0e0e0';
                let c2 = i%2===0 ? '#c0392b' : '#27ae60'; // ç´…/ç¶ 
                
                h += createPath(ang, R.din, R.tout, c1); // å–®å€å¤–
                h += createPath(ang, R.dout, R.din, c2); // å…©å€
                h += createPath(ang, R.tin, R.bull, c1); // å–®å€å…§
                h += createPath(ang, R.tout, R.tin, c2); // ä¸‰å€

                // æ•¸å­—
                let rad = ang * Math.PI/180;
                let tx = Math.cos(rad)*190;
                let ty = Math.sin(rad)*190 + 6;
                h += `<text x="${tx}" y="${ty}" text-anchor="middle" fill="#fff" font-weight="bold" font-size="24">${num}</text>`;
            }
            // ç´…å¿ƒ
            h += `<circle cx="0" cy="0" r="32" fill="#27ae60" stroke="#ddd" />`;
            h += `<circle cx="0" cy="0" r="14" fill="#c0392b" stroke="none" />`;
            
            svg.innerHTML = h;
        }

        function createPath(ang, rOut, rIn, col) {
            let a1 = (ang-9)*Math.PI/180;
            let a2 = (ang+9)*Math.PI/180;
            let d = `M ${Math.cos(a1)*rOut} ${Math.sin(a1)*rOut} A ${rOut} ${rOut} 0 0 1 ${Math.cos(a2)*rOut} ${Math.sin(a2)*rOut} L ${Math.cos(a2)*rIn} ${Math.sin(a2)*rIn} A ${rIn} ${rIn} 0 0 0 ${Math.cos(a1)*rIn} ${Math.sin(a1)*rIn} Z`;
            return `<path d="${d}" fill="${col}" stroke="#888" stroke-width="1" />`;
        }

        // --- æ ¸å¿ƒï¼šè§¸æ§/é»æ“Š åº§æ¨™è¨ˆç®— ---
        function initTouchEvents() {
            const pad = document.getElementById('touch-layer');
            const btnOut = document.getElementById('btn-out');

            // æ”¯æ´ touchstart èˆ‡ mousedown
            // ç‚ºäº†é¿å… ghost clickï¼Œæˆ‘å€‘åªç›£è½ touchstart (å¦‚æœæ”¯æ´) æˆ– mousedown
            
            const handleInput = (e) => {
                // å¦‚æœæ˜¯ touch äº‹ä»¶ï¼Œé˜»æ­¢é è¨­è¡Œç‚º (é¿å…æ²å‹•ã€é›™æ“Šç¸®æ”¾)
                if(e.type === 'touchstart') e.preventDefault();
                
                if(isLock || state.darts >= 3) return;

                // å–å¾—åº§æ¨™ (ç›¸å°æ–¼ board-container)
                let clientX, clientY;
                if(e.changedTouches && e.changedTouches.length > 0) {
                    clientX = e.changedTouches[0].clientX;
                    clientY = e.changedTouches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                const rect = pad.getBoundingClientRect();
                const x = clientX - rect.left - rect.width/2; // ä»¥ä¸­å¿ƒç‚º 0,0
                const y = clientY - rect.top - rect.height/2;

                // é™¤éŒ¯é¡¯ç¤º
                document.getElementById('debug-info').innerText = `X:${Math.round(x)} Y:${Math.round(y)}`;

                calculateScore(x, y, clientX, clientY);
            };

            // ä½¿ç”¨ passive: false æ‰èƒ½ preventDefault
            pad.addEventListener('touchstart', handleInput, {passive:false});
            pad.addEventListener('mousedown', handleInput);

            // OUT æŒ‰éˆ•
            const handleOut = (e) => {
                if(e.type === 'touchstart') e.preventDefault();
                processHit(0, 0, "MISS", null);
            };
            btnOut.addEventListener('touchstart', handleOut, {passive:false});
            btnOut.addEventListener('mousedown', handleOut);
            btnOut.addEventListener('click', (e)=>e.preventDefault()); // é˜²æ­¢ click ç©¿é€
        }

        // --- æ•¸å­¸è¨ˆç®—åˆ†æ•¸ ---
        function calculateScore(x, y, absX, absY) {
            // 1. è¨ˆç®—åŠå¾‘ r
            // é£›é¢ç›¤ SVG è¨­å®šç‚º 410x410 (viewBox -205~205)
            // ä½†å¯¦éš› DOM å¤§å°å¯èƒ½æ˜¯ 340pxã€‚æˆ‘å€‘éœ€è¦æ¯”ä¾‹è½‰æ›ã€‚
            const container = document.getElementById('board-container');
            const scale = 410 / container.offsetWidth; // æ¯”ä¾‹å°º ( SVGå–®ä½ / åƒç´  )
            
            const r = Math.sqrt(x*x + y*y) * scale;
            const deg = Math.atan2(y, x) * 180 / Math.PI; // -180 ~ 180

            // 2. åˆ¤æ–·åˆ†æ•¸
            let val = 0, mult = 1;
            
            if (r < 32) {
                // ç´…å¿ƒ (çµ±ä¸€ 50)
                val = 50; mult = 1;
            } else if (r > 170) {
                // å‡ºç•Œ (é›–ç„¶è¦–è¦ºä¸ŠåŠå¾‘åˆ° 200ï¼Œä½†è¨ˆåˆ†åªåˆ° 170)
                // é€™è£¡ç®— MISS
                processHit(0, 0, "MISS", {x:absX, y:absY});
                return;
            } else {
                // åˆ¤æ–·å€æ•¸
                if (r >= 32 && r < 97) mult = 1;       // å…§å–®å€
                else if (r >= 97 && r < 107) mult = 3; // ä¸‰å€
                else if (r >= 107 && r < 160) mult = 1;// å¤–å–®å€
                else if (r >= 160 && r <= 170) mult = 2;// å…©å€

                // åˆ¤æ–·æ•¸å­— (è§’åº¦)
                // ä¸Šæ–¹ (-90åº¦) æ˜¯ 20åˆ†
                // ä¿®æ­£è§’åº¦ï¼šè®“ -90åº¦ è®Šæˆ 0åº¦ (index 0)
                // æ¯å€‹å€å¡Š 18åº¦ã€‚OFFSET = +90 + 9 (æ ¡æ­£ä½ç§»)
                let angleIndex = Math.floor((deg + 90 + 9 + 360) % 360 / 18);
                // ç¢ºä¿ index åœ¨ 0-19
                angleIndex = angleIndex % 20;
                val = ORDER[angleIndex];
            }

            processHit(val, mult, null, {x:absX, y:absY});
        }

        // --- è™•ç†è¨ˆåˆ†é‚è¼¯ ---
        function processHit(val, mult, forceText, pos) {
            if(isLock) return;
            isLock = true;

            // å¼·åˆ¶è§£é–ä¿éšª (250ms)
            setTimeout(() => isLock=false, 250);

            const p = state.players[state.idx];
            const points = val * mult;
            let txt = forceText ? forceText : (val===50?"BULL":(mult===3?"T"+val:(mult===2?"D"+val:val)));
            
            // ç‰¹æ•ˆ
            if(pos) showFx(txt, pos.x, pos.y, val, mult);

            // ç´€éŒ„æ­·å²
            state.history.push({
                idx: state.idx, prev: p.score, r: state.round, d: state.darts,
                rs: [...state.rScores], rv: [...state.rValues]
            });

            // æ›´æ–°åˆ†æ•¸
            let newScore = p.score - points;
            
            // è¦å‰‡åˆ¤å®š
            if(newScore < 0) {
                // çˆ†åˆ†
                state.rScores.push("BUST");
                showToast("BUST!");
                p.score = p.temp;
                setTimeout(() => nextTurn(true), 1000);
            } else if(newScore === 0) {
                // ç²å‹
                p.score = 0;
                updateUI();
                document.getElementById('winner-screen').classList.remove('hidden');
                document.getElementById('lbl-winner').innerText = `Player ${state.idx+1}`;
            } else {
                // æ­£å¸¸
                p.score = newScore;
                state.rScores.push(txt);
                state.rValues.push(points);
                state.darts++;
                updateUI();

                if(state.darts >= 3) {
                    setTimeout(() => nextTurn(false), 300);
                }
            }
        }

        function nextTurn(isBust) {
            const p = state.players[state.idx];
            const lost = isBust ? 0 : (p.temp - p.score);
            log(`P${state.idx+1}: [${state.rScores.join(',')}] -${lost} â†’ ${p.score}`);
            
            p.temp = p.score;
            state.darts=0; state.rScores=[]; state.rValues=[];
            
            document.getElementById(`p-${state.idx}`).classList.remove('active');
            state.idx++;
            if(state.idx >= cfg.players) {
                state.idx = 0;
                state.round++;
                log(`--- Round ${state.round} ---`, true);
            }
            document.getElementById(`p-${state.idx}`).classList.add('active');
            updateUI();
            isLock = false;
        }

        function undo() {
            if(state.history.length===0 || isLock) return;
            let h = state.history.pop();
            
            if(h.idx !== state.idx) {
                document.getElementById(`p-${state.idx}`).classList.remove('active');
                state.idx = h.idx; state.round = h.r;
                document.getElementById(`p-${state.idx}`).classList.add('active');
                // ç°¡å–®è™•ç†ï¼šæ‚”æ£‹è·¨å›åˆæ™‚ç§»é™¤æœ€å¾Œä¸€æ¢ log
                let list = document.getElementById('log-list');
                if(list.lastChild) list.removeChild(list.lastChild);
            }

            let p = state.players[h.idx];
            p.score = h.prev;
            state.darts = h.d;
            state.rScores = h.rs;
            state.rValues = h.rv;
            updateUI();
        }

        function updateUI() {
            state.players.forEach(pp => document.getElementById(`s-${pp.id}`).innerText = pp.score);
            document.getElementById('d-'+state.idx).innerText = state.rScores.join(' ');
            document.getElementById('lbl-round').innerText = state.round;
        }

        function showFx(txt, x, y, val, mult) {
            let d = document.createElement('div');
            d.className = 'hit-fx';
            d.innerText = txt;
            d.style.left = x + 'px';
            d.style.top = y + 'px';
            d.style.color = (val===50?"#2ecc71":(mult===3?"#c0392b":(mult===2?"#f1c40f":"#fff")));
            document.body.appendChild(d);
            setTimeout(()=>d.remove(), 500);
        }

        function showToast(msg) {
            let d = document.createElement('div');
            d.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:#e74c3c;font-size:3rem;font-weight:bold;padding:20px;border:2px solid #e74c3c;border-radius:10px;z-index:200;";
            d.innerText = msg;
            document.body.appendChild(d);
            setTimeout(()=>d.remove(), 1000);
        }

        function log(msg, isHead) {
            let ul = document.getElementById('log-list');
            let li = document.createElement('li');
            if(isHead) {
                li.className = 'log-head';
                li.innerText = msg;
            } else {
                li.className = 'log-item';
                li.innerText = msg;
            }
            ul.appendChild(li);
            ul.scrollTop = ul.scrollHeight;
        }

    </script>
</body>
</html>
